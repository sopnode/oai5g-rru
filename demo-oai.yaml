
# WARNING: this file was produced automatically - DO NOT EDIT !
# see demo-oai.yaml.j2 instead
#
# expected jinja variables, set by calling python script
# faraday.inria.fr - typically 'faraday.inria.fr'
# sopnode-w2.inria.fr - typically 'sopnode-l1.inria.fr'
# oai5g - typically 'oai5g'
# True - typically 'True' or 'False'
# {'k8s_fit': 'fit01', 'amf_spgwu': 'sopnode-w3.inria.fr', 'gnb': 'sopnode-w2.inria.fr'} - typically {'k8s_fit': 'fit01', 'amf_spgwu': 'sopnode-w3.inria.fr', 'gnb' : 'sopnode-w2.inria.fr'}
# {{ quectel_nodes }} - typically {'9': 'fit09', '18': 'fit18'}
# n300 - typically 'n300' or 'n320' or 'jaguar' or 'panther'
# {'name': 'r2labuser', 'password': 'r2labuser-pwd', 'email': 'r2labuser@turletti.com'} - typically {'name': 'jdoe', 'password': 'XX', 'email': 'jdoe@yahoo.fr'}
# kubernetes - typically 'kubernetes'
# quectel-wwan0 - typically 'quectel-wwan0'
# True - typically 'True' or 'False'

nodes:
  - id: faraday
    hostname: faraday.inria.fr
    formatter: TimeHostFormatter
    verbose: True
  - id: leader
    hostname: sopnode-w2.inria.fr
    gateway: faraday
    username: r2lab
    formatter: TimeHostFormatter
    verbose: True
  
  - id: k8s_fit
    hostname: fit01
    gateway: faraday
    username: root
    formatter: TimeHostFormatter
    verbose: True
  
  - id: amf_spgwu
    hostname: sopnode-w3.inria.fr
    gateway: faraday
    username: root
    formatter: TimeHostFormatter
    verbose: True
  
  - id: gnb
    hostname: sopnode-w2.inria.fr
    gateway: faraday
    username: root
    formatter: TimeHostFormatter
    verbose: True
  
  

jobs:
  - id: load-images
    node: faraday
    critical: True
    verbose: True
    label: load image kubernetes on FIT worker node
    commands:
      - type: Run
        command: >
          rhubarbe load -i kubernetes fit01
      - type: Run
        command: >
          rhubarbe wait fit01
      - type: Run
        command: >
          rhubarbe script on-n300

  

  

  # for now, useless to switch off other nodes as we use RfSimulator
  # - id: turn-off-others
  #   node: faraday
  #   critical: False
  #   verbose: True
  #   label: turn off unused nodes
  #   commands:
  #   - type: Run
  #     command: >
  #       rhubarbe bye -- ~fit01 ~sopnode-w3.inria.fr ~sopnode-w2.inria.fr 
  #   - type: Run
  #     command: sleep 1
  #

  - id: leave-join-k8s-fit-node
    required:
    - load-images
    node: k8s_fit
    critical: False
    verbose: True
    label: >
      Prepare node fit01 for k8s & networking
    commands:
      - type: Run
        command: nmcli con down data; nmcli dev status; leave-tunnel
      - type: Run
        command: kube-install.sh leave-cluster
      - type: Run
        command: sleep 60
      - type: Run
        command: nmcli con up data; nmcli dev status; join-tunnel
      - type: Run
        command: kube-install.sh join-cluster r2lab@sopnode-w2.inria.fr

  - id: init-demo
    required:
      - leave-join-k8s-fit-node
    node: k8s_fit
    critical: True
    verbose: True
    label: >
      Clone oai5g-rru, configure demo-oai.sh script on fit01,
      clone oai-cn5g-fed, apply patches for SophiaNode R2lab environment,
      and run the k8s demo-oai script from fit01
    commands:
      - type: Run
        command: >
          rm -rf oai5g-rru;
          git clone -b master https://github.com/sopnode/oai5g-rru.git;
          cp oai5g-rru/demo-oai.sh /root/;
          chmod a+x /root/demo-oai.sh;
          cp oai5g-rru/configure-demo-oai.sh /root/;
          chmod a+x /root/configure-demo-oai.sh;
          /root/configure-demo-oai.sh update oai5g sopnode-w3.inria.fr sopnode-w2.inria.fr True r2labuser r2labuser-pwd r2labuser@turletti.com ;
          rm -rf oai-cn5g-fed;
          git clone -b master https://gitlab.eurecom.fr/turletti/oai-cn5g-fed.git;
      - type: Run
        command: /root/demo-oai.sh init oai5g n300 True
      - type: Run
        command: /root/demo-oai.sh configure-all sopnode-w3.inria.fr sopnode-w2.inria.fr n300 True

  - id: start-demo
    required: init-demo
    node: k8s_fit
    critical: True
    verbose: True
    label: >
      Launch OAI5G pods by calling demo-oai.sh start from {{ k8s_fit }}
    commands:
      - type: Run
        command: /root/demo-oai.sh start oai5g sopnode-w3.inria.fr sopnode-w2.inria.fr True

  

  - id: stop-demo
    required: start-demo
    node: k8s_fit
    critical: True
    verbose: True
    label: >
      Delete OAI5G pods by calling demo-oai.sh stop from fit01
    commands:
      - type: Run
        command: /root/demo-oai.sh stop oai5g True
      
      - type: Pull
        remotepaths: "/tmp/oai5g-stats.tgz"
        localpath: "./"
      

  

  - id: cleanup1
    required: stop-demo
    node: leader
    critical: False
    verbose: True
    label: Drain and delete FIT nodes from the k8s sopnode-w2.inria.fr cluster
    commands:
      - type: Run
        command: fit-drain-nodes; fit-delete-nodes

  - id: cleanup2
    required: stop-demo
    node: faraday
    critical: False
    verbose: True
    commands:
      - type: Run
        command: >
          rhubarbe script off-n300
      - type: Run
        command: rhubarbe off fit01

  